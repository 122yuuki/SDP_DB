# SQL発展（検索がメイン）

## 復習

### テーブルの作成

テーブルの作成には `create table テーブル名` を使用する。カラムについてはテーブル名の後に記述する。  
例）「氏」（10文字）、「名」（10文字）のカラムを持つ「人」というテーブル  

```
create table 人 (
    氏 varchar(10),
    名 varchar(10)
);
```

### CRUD

* C：Create（作成）
* R：Read（読み出し）
* U：Update（更新）
* D：Delete（削除）

### Create（作成）

`insert` を用いてテーブルにタプルを追加する。  
例）「人」テーブルに「千歳 太郎」を追加する
```
insert into 人 values ('千歳', '太郎');
```

### Read（読み出し）

`select` を用いてテーブルからデータを取得する。
例）「人」テーブルから全てのデータを取得する
```
select * from 人;
```

### Update（更新）

`update` を用いてデータを更新する。
例）「人」テーブルに存在する「千歳 太郎」を「千歳 光」に更新する
```
update 人 set 名 = '光' where 氏 = '千歳';
```
※where句：条件を付けてデータを絞り込む。上記の場合、「氏」が「千歳」のタプルを指定している。

### Delete（削除）

`delete` を用いてデータを削除する
例）「人」テーブルに存在する「千歳 光」を削除する
```
delete from 人 where 氏 = '千歳';
```
「氏」「名」の両方を指定する場合
```
delete from 人 where 氏 = '千歳' and 名 = '光';
```


## 以下の演習で使用するテーブル一覧

1.学生
| 学籍番号 | 氏 | 名 | クラス |
| ---- | ---- | ---- | ---- |
| b2220001 | 千歳 | 太郎 | A |
| b2220002 | 札幌 | 次郎 | A |
| b2220003 | 恵庭 | 三郎 | B |
| b2220004 | 小樽 | 四郎 | B |
| b2220005 | 北見 | 五郎 | A |


2.中間テスト
| 学籍番号 | 得点 | 
| ---- | ---- |
| b2220001 | 70 |
| b2220002 | 62 |
| b2220003 | 95 |

3.期末テスト
| 学籍番号 | 得点 |
| ---- | ---- |
| b2220001 | 80 |
| b2220002 | 77 |
| b2220003 | 86 |
| b2220005 | 40 |

## 検索結果の加工

### 昇順に並び替える
```
select * from 中間テスト
order by 得点 asc;
```

出力結果
| 学籍番号 | 得点 | 
| ---- | ---- |
| b2220002 | 62 |
| b2220001 | 70 |
| b2220003 | 95 |

### 降順に並び替える
```
select * from 中間テスト
order by 得点 desc;
```

出力結果
| 学籍番号 | 得点 | 
| ---- | ---- |
| b2220003 | 95 |
| b2220001 | 70 |
| b2220002 | 62 |

### 先頭から指定した行数だけ取得する
```
select * from 中間テスト
order by 得点 asc
limit 2;
```

出力結果
| 学籍番号 | 得点 | 
| ---- | ---- |
| b2220002 | 62 |
| b2220001 | 70 |

### 重複した行を除外する
以下のクエリを先に実行する（このパートでのみ使用）
```
insert into 学生
values ('b2220001', '千歳', '太郎', 'A'),
       ('b2220003', '恵庭', '三郎', 'B'),
       ('b2220007', '北広島', '六郎', 'B');
```
※上記クエリ実行後の結果は自分で考える

```
select distinct 学籍番号 from 学生;
```

出力結果
| 学籍番号 |
| ---- |
| b2220001 |
| b2220002 |
| b2220003 |
| b2220004 |
| b2220005 |
| b2220007 |

### 同じ値を持つ組を集計する
```
select クラス, count(学籍番号) from 学生
group by クラス;
```

出力結果
| クラス | count(学籍番号) | 
| ---- | ---- |
| A | 3 |
| B | 2 |


## 結合

### inner join

例1）
```
select 学生.学籍番号, 中間テスト.得点 from 学生
inner join 中間テスト
on 学生.学籍番号 = 中間テスト.学籍番号;
```

出力結果
| 学籍番号 | 得点 | 
| ---- | ---- |
| b2220001 | 70 |
| b2220002 | 62 |
| b2220003 | 95 |

例2）
```
select 学生.学籍番号, 期末テスト.得点 from 学生
inner join 期末テスト
on 学生.学籍番号 = 期末テスト.学籍番号;
```

出力結果
| 学籍番号 | 得点 | 
| ---- | ---- |
| b2220001 | 70 |
| b2220002 | 62 |
| b2220003 | 95 |
| b2220004 | 40 |

### outer join

例1）
```
select 学生.学籍番号, 中間テスト.得点 from 学生
left outer join 中間テスト
on 学生.学籍番号 = 中間テスト.学籍番号;
```

出力結果
| 学籍番号 | 得点 | 
| ---- | ---- |
| b2220001 | 70 |
| b2220002 | 62 |
| b2220003 | 95 |
| b2220004 | null |
| b2220005 | null |

例2）
```
select 学生.学籍番号, 期末テスト.得点 from 学生
left outer join 期末テスト
on 学生.学籍番号 = 期末テスト.学籍番号;
```

出力結果
| 学籍番号 | 得点 | 
| ---- | ---- |
| b2220001 | 70 |
| b2220002 | 62 |
| b2220003 | 95 |
| b2220004 | 40 |
| b2220005 | null |


## 総合演習

### 問1
学生テーブルと中間テストテーブルの2つが存在する。テーブルは以下の通りである。

1.学生
| 学籍番号 | 氏 | 名 | クラス |
| ---- | ---- | ---- | ---- |
| b2220001 | 千歳 | 太郎 | A |
| b2220002 | 札幌 | 次郎 | A |
| b2220003 | 恵庭 | 三郎 | B |
| b2220004 | 小樽 | 四郎 | B |
| b2220005 | 北見 | 五郎 | C |

2.中間テスト
| 学籍番号 | 得点 | 
| ---- | ---- |
| b2220001 | 70 |
| b2220002 | 62 |
| b2220003 | 95 |
| b2220005 | 80 |

2つのテーブルを結合させ、中間テストの得点が高い順に並び替えたい。

これらのテーブルに対して以下のクエリを実行する。
```
select (    ), (    ), (    )
from 学生
(    ) (    ) 中間テスト
(    ) 学生.(    ) = 中間テスト.(    )
(    ) (    ) 中間テスト.(    ) (    );
```

出力結果が以下の通りである。
| 学籍番号 | クラス | 得点 | 
| ---- | ---- | ---- |
| b2220003 | B | 95 |
| b2220005 | C | 80 |
| b2220001 | A | 70 |
| b2220002 | A | 62 |

### 問2

問1に期末テストテーブルを追加する。期末テストテーブルは以下の通りである。

3.期末テスト
| 学籍番号 | 得点 |
| ---- | ---- |
| b2220001 | 80 |
| b2220002 | 77 |
| b2220003 | 86 |
| b2220004 | 56 |
| b2220005 | 40 |

以上3つのテーブルから、中間テストの得点と期末テストの得点が共に70点以上の学生のみ表示させたい。

まず、3つのテーブルを結合させる。

```
select (    ), (    ), (    ), (    )
from 学生
(    ) (    ) join 中間テスト
(    ) 学生.(    ) = 中間テスト.(    )
(    ) (    ) join 期末テスト
(    ) 学生.(    ) = 期末テスト.(    );
```

出力結果は以下の通りである。

| 学籍番号 | クラス | 中間テスト.得点 | 期末テスト.得点 | 
| ---- | ---- | ---- | ---- |
| b2220001 | A | 70   | 80 |
| b2220002 | A | 62   | 77 |
| b2220003 | B | 95   | 86 |
| b2220004 | B | null | 56 |
| b2220005 | C | 80   | 40 |

上記の出力結果をもとに、さらに絞り込む。

```
select (    ), (    ), (    ), (    )
from 学生
(    ) (    ) join 中間テスト
(    ) 学生.(    ) = 中間テスト.(    )
(    ) (    ) join 期末テスト
(    ) 学生.(    ) = 期末テスト.(    )
where 中間テスト.得点 (    ) 70 (    ) 期末テスト.得点 (    ) 70;
```

出力結果は以下の通りである。

| 学籍番号 | クラス | 中間テスト.得点 | 期末テスト.得点 | 
| ---- | ---- | ---- | ---- |
| b2220001 | A | 70   | 80 |
| b2220003 | B | 95   | 86 |


ヒント：AかつBはAND、AまたはBはOR

### 問3

問1、問2で使用した3つのテーブルを使用し、クラスごとの中間テストと期末テストそれぞれの平均点を算出したい。また、期末テストの平均点が低い順に並び替えたい。

ただし、どちらか一方でもテストを受験していない場合、その学生の得点は中間・期末ともに省くものとする。

```
select (    ), (    )(中間テスト.得点), (    )(期末テスト.得点)
from 学生
(    ) (    ) join 中間テスト
(    ) 学生.学籍番号 = 中間テスト.学籍番号
(    ) (    ) join 期末テスト
(    ) 学生.学籍番号 = 期末テスト.学籍番号
(    ) 中間テスト.得点 (    ) (    ) (    ) (    ) 期末テスト.得点 (    ) (    ) (    )
(    ) by 学生.クラス
(    ) by (    )(期末テスト.得点) (    );
```

出力結果は以下の通りである。

| クラス | avg(中間テスト.得点) | avg(期末テスト.得点) | 
| ---- | ---- | ---- |
| C | 80 | 40 |
| A | 66 | 78.5 |
| B | 95 | 86 |


ヒント

* 合計の算出：sum、最大値の算出：max、最小値の算出：min、平均値の算出：avg、行数のカウント：count
* 値がnullであるか：is null、値がnull以外であるか：is not null

___

[目次へ](https://github.com/122yuuki/SDP_DB/blob/main/README.md)

___

## 参考

* SQL構文まとめ：https://qiita.com/tatsuya4150/items/69c2c9d318e5b93e6ccd
* SQL記述者全員が理解すべきSELECT文の論理的な処理順序のお話：https://qiita.com/k_0120/items/a27ea1fc3b9bddc77fa1
